#!/bin/bash
# Coders CLI launcher
# Prefers Go binary if available, falls back to Node.js

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PLUGIN_DIR="$SCRIPT_DIR/.."

# Detect platform
OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
ARCH="$(uname -m)"

# Normalize architecture names
case "$ARCH" in
    x86_64)
        ARCH="amd64"
        ;;
    aarch64|arm64)
        ARCH="arm64"
        ;;
esac

# Try platform-specific binary in plugin distribution
PLATFORM_BINARY="$PLUGIN_DIR/bin/platform/coders-${OS}-${ARCH}"
if [[ -x "$PLATFORM_BINARY" ]]; then
    exec "$PLATFORM_BINARY" "$@"
fi

# Check for Go binary in the monorepo (development mode)
MONOREPO_BINARY="$PLUGIN_DIR/../go/bin/coders"
if [[ -x "$MONOREPO_BINARY" ]]; then
    exec "$MONOREPO_BINARY" "$@"
fi

# Check for Go binary in PATH
if command -v coders-go &> /dev/null; then
    exec coders-go "$@"
fi

# Fall back to Node.js implementation
cd "$PLUGIN_DIR"
exec node skills/coders/scripts/main.js "$@"
