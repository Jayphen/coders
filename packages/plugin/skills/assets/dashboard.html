<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coders Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/ansi_up@5.1.0/ansi_up.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }


    :root {
      --tui-bg: #0b0f14;
      --tui-surface: #0f141b;
      --tui-panel: #121821;
      --tui-border: #2b323c;
      --tui-border-strong: #39424e;
      --tui-text: #c9d1d9;
      --tui-muted: #8b949e;
      --tui-accent: #58a6ff;
      --tui-accent-soft: rgba(88, 166, 255, 0.18);
      --tui-mono: "Space Mono", "JetBrains Mono", "Fira Code", Menlo, Consolas, monospace;
      --tui-sans: "Space Grotesk", "IBM Plex Sans", "Sora", sans-serif;
    }

    body {
      font-family: var(--tui-sans);
      background: radial-gradient(circle at top left, rgba(88, 166, 255, 0.08), transparent 45%),
        radial-gradient(circle at 20% 20%, rgba(46, 160, 67, 0.05), transparent 35%),
        linear-gradient(160deg, #0a0e14 0%, #0d1117 40%, #0b0f14 100%);
      color: var(--tui-text);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      overflow-x: hidden;
    }

    img, video, canvas {
      max-width: 100%;
      height: auto;
    }

    h1 {
      color: var(--tui-accent);
      margin-bottom: 10px;
      font-size: 32px;
      font-family: var(--tui-mono);
      letter-spacing: 0.5px;
    }

    .subtitle {
      color: var(--tui-muted);
      margin-bottom: 30px;
    }

    .dashboard-layout {
      display: grid;
      grid-template-columns: clamp(240px, 28vw, 360px) minmax(0, 1fr);
      gap: 0;
      align-items: stretch;
      border: 1px solid var(--tui-border);
      border-radius: 12px;
      background: var(--tui-surface);
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
    }

    .sessions-pane,
    .preview-pane {
      background: transparent;
      border: none;
      padding: 18px 20px;
      min-width: 0;
      min-height: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .sessions-pane {
      border-right: 1px solid var(--tui-border);
      background: linear-gradient(180deg, rgba(18, 24, 33, 0.9) 0%, rgba(12, 17, 24, 0.85) 100%);
    }

    .preview-pane {
      min-height: 520px;
      gap: 12px;
      background: linear-gradient(180deg, rgba(15, 20, 27, 0.98) 0%, rgba(10, 14, 20, 0.95) 100%);
    }

    .sessions-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding-right: 6px;
    }

    .session-card {
      background: #141a22;
      border: 1px solid var(--tui-border);
      border-radius: 8px;
      padding: 14px 16px;
      transition: border-color 0.2s, background 0.2s;
      cursor: pointer;
    }

    .session-card.stale {
      opacity: 0.5;
    }

    .session-card.orchestrator {
      background: linear-gradient(135deg, #1e2a3a 0%, #141a22 100%);
      border: 2px solid var(--tui-accent);
      box-shadow: 0 0 24px var(--tui-accent-soft);
    }

    .session-card:hover {
      border-color: var(--tui-accent);
    }

    .session-card.selected {
      border-color: var(--tui-accent);
      background: #1a2330;
    }

    .session-card.completed {
      border-color: #2ea043;
      background: #101a14;
    }

    .session-card.completed.blocked {
      border-color: #f85149;
      background: #1f1113;
    }

    .session-card.completed.needs-review {
      border-color: #d29922;
      background: #201a11;
    }

    .session-card.completed.selected,
    .session-card.completed.blocked.selected,
    .session-card.completed.needs-review.selected {
      border-color: var(--tui-accent);
      background: #1a2330;
    }

    .session-card.pulse {
      animation: pulse-glow 1.2s ease-out;
    }

    @keyframes pulse-glow {
      0% {
        box-shadow: 0 0 0 rgba(88, 166, 255, 0);
      }
      50% {
        box-shadow: 0 0 14px rgba(88, 166, 255, 0.35);
      }
      100% {
        box-shadow: 0 0 0 rgba(88, 166, 255, 0);
      }
    }

    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .session-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--tui-text);
      font-family: var(--tui-mono);
    }

    .session-display-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--tui-accent);
      font-family: var(--tui-sans);
      margin-bottom: 2px;
    }

    .session-id {
      font-size: 11px;
      color: #6e7681;
      font-family: var(--tui-mono);
    }

    .session-name-container {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .session-name,
    .session-display-name,
    .session-id {
      overflow-wrap: anywhere;
      min-width: 0;
    }

    .status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status.active {
      background: #238636;
      color: #fff;
    }

    .status.idle {
      background: #9e6a03;
      color: #fff;
    }

    .status.waiting {
      background: #1f6feb;
      color: #fff;
    }

    .status.stale {
      background: #6e7681;
      color: #fff;
    }

    .status.unknown {
      background: #30363d;
      color: #8b949e;
    }

    .session-statuses {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .promise-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      background: #2ea043;
      color: #fff;
      letter-spacing: 0.3px;
    }

    .promise-badge.blocked {
      background: #da3633;
    }

    .promise-badge.needs-review {
      background: #bf8700;
    }

    .session-info {
      margin-bottom: 0;
      font-size: 14px;
      color: #8b949e;
    }

    .session-info div {
      margin-bottom: 4px;
    }

    .session-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 12px;
      color: #6e7681;
    }

    .session-meta span {
      min-width: 0;
      overflow-wrap: anywhere;
    }

    .session-meta .divider {
      opacity: 0.4;
    }

    .session-task {
      color: #a7b0bb;
      font-size: 13px;
      line-height: 1.4;
    }

    .promise-summary {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid #30363d;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      color: #b1bac4;
    }

    .promise-summary .promise-time {
      font-size: 11px;
      color: #8b949e;
    }

    .promise-summary .promise-text {
      color: #c9d1d9;
      font-size: 13px;
      line-height: 1.4;
    }

    .promise-summary .promise-blockers {
      color: #f85149;
      font-size: 12px;
    }

    .typing-indicator {
      display: inline-flex;
      gap: 4px;
      margin-left: 8px;
      vertical-align: middle;
    }

    .typing-dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: #58a6ff;
      opacity: 0.5;
      animation: typing-bounce 1s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.15s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes typing-bounce {
      0%, 80%, 100% {
        transform: translateY(0);
        opacity: 0.4;
      }
      40% {
        transform: translateY(-3px);
        opacity: 0.9;
      }
    }

    .heartbeat-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
      animation: pulse 2s infinite;
    }

    .heartbeat-indicator.has-heartbeat {
      background: #3fb950;
    }

    .heartbeat-indicator.no-heartbeat {
      background: #6e7681;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    button {
      padding: 8px 16px;
      border: 1px solid var(--tui-border);
      background: #1c222b;
      color: var(--tui-text);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    button:hover {
      background: #2a323d;
      border-color: var(--tui-accent);
    }

    button:active {
      transform: scale(0.98);
    }

    .output-panel {
      background: #0b0f14;
      border: 1px solid var(--tui-border);
      border-radius: 6px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
      min-height: 0;
      min-width: 0;
    }

    .output-panel.empty .output-content,
    .output-panel.empty .send-message,
    .output-panel.empty .send-message-hint,
    .output-panel.empty .special-keys-section {
      display: none;
    }

    .output-panel.empty .preview-empty {
      display: flex;
    }

    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 0;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--tui-border);
    }

    .output-header > div {
      min-width: 0;
    }

    .output-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--tui-accent);
      font-family: var(--tui-mono);
      overflow-wrap: anywhere;
    }

    .output-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      row-gap: 6px;
      margin-top: 6px;
      font-size: 12px;
      color: var(--tui-muted);
      align-items: center;
    }

    .output-meta span {
      min-width: 0;
    }

    #output-cwd,
    #orchestrator-cwd {
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .output-meta .meta-divider {
      opacity: 0.4;
    }

    .output-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .output-actions button.ghost {
      background: transparent;
      border-color: transparent;
      color: var(--tui-muted);
    }

    .output-actions button.ghost:hover {
      border-color: var(--tui-border);
      color: var(--tui-text);
    }

    .close-btn {
      background: transparent;
      border: none;
      color: var(--tui-muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
    }

    .close-btn:hover {
      color: var(--tui-text);
    }

    .output-content {
      background: #000;
      padding: 15px;
      border-radius: 6px;
      font-family: var(--tui-mono);
      font-size: 13px;
      line-height: 1.6;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
      flex: 1;
      min-height: 240px;
      max-height: none;
      overflow-y: auto;
    }

    .output-promise {
      display: none;
      flex-direction: column;
      gap: 8px;
      background: #0f1a12;
      border: 1px solid #2ea043;
      border-radius: 6px;
      padding: 12px;
      font-size: 13px;
      color: #c9d1d9;
    }

    .output-promise.visible {
      display: flex;
    }

    .output-promise.blocked {
      background: #1f1113;
      border-color: #f85149;
    }

    .output-promise.needs-review {
      background: #201a11;
      border-color: #d29922;
    }

    .output-promise-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .output-promise-time {
      font-size: 12px;
      color: #8b949e;
    }

    .output-promise-summary {
      font-size: 13px;
      line-height: 1.4;
    }

    .output-promise-blockers {
      color: #f85149;
      font-size: 12px;
    }

    .send-message {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: flex-start;
    }

    .message-textarea {
      flex: 1 1 220px;
      padding: 8px 12px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      color: #c9d1d9;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 38px;
      max-height: 200px;
      line-height: 1.4;
      min-width: 0;
    }

    .message-textarea:focus {
      outline: none;
      border-color: #58a6ff;
    }

    .message-textarea:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .send-message-hint {
      font-size: 11px;
      color: #6e7681;
      margin-top: 4px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #8b949e;
    }

    .empty-state h2 {
      font-size: 24px;
      margin-bottom: 10px;
      color: #c9d1d9;
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 20px;
      flex: 1;
      min-width: 200px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #58a6ff;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #8b949e;
      font-size: 14px;
    }

    .orchestrator-badge {
      display: inline-block;
      background: linear-gradient(135deg, #58a6ff 0%, #1f6feb 100%);
      color: #fff;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      margin-left: 8px;
      letter-spacing: 0.5px;
    }

    .orchestrator-panel {
      background: linear-gradient(135deg, #1e2a3a 0%, #161b22 100%);
      border: 2px solid #58a6ff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 0 30px rgba(88, 166, 255, 0.3);
    }

    .orchestrator-panel.hidden {
      display: none;
    }

    .orchestrator-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #30363d;
    }

    .orchestrator-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .orchestrator-title h2 {
      font-size: 20px;
      color: #58a6ff;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .orchestrator-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex: 1;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .orchestrator-input-group {
      display: flex;
      gap: 10px;
      flex: 1;
      flex-wrap: wrap;
      min-width: 0;
    }

    .orchestrator-input-group input {
      flex: 1 1 220px;
      padding: 10px 15px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      color: #c9d1d9;
      font-size: 14px;
      min-width: 0;
    }

    .orchestrator-input-group input:focus {
      outline: none;
      border-color: #58a6ff;
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
    }

    .orchestrator-input-group button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #58a6ff 0%, #1f6feb 100%);
      border: none;
      color: white;
      font-weight: 600;
    }

    .orchestrator-input-group button:hover {
      background: linear-gradient(135deg, #6cb6ff 0%, #3d8bfd 100%);
    }

    .orchestrator-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      font-size: 13px;
      color: #8b949e;
    }

    .orchestrator-stat {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .orchestrator-stat-label {
      color: #6e7681;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .orchestrator-stat-value {
      color: #58a6ff;
      font-size: 14px;
      font-weight: 600;
      overflow-wrap: anywhere;
    }

    .sections-divider {
      margin: 40px 0 30px 0;
      border: 0;
      height: 1px;
      background: linear-gradient(to right, transparent, #30363d, transparent);
    }

    .section-title {
      color: var(--tui-muted);
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 20px;
      font-family: var(--tui-mono);
    }

    /* Special keys styles */
    .special-keys-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #30363d;
    }

    .special-keys-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .special-keys-title {
      font-size: 13px;
      color: #8b949e;
      font-weight: 600;
    }

    .tool-selector {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .tool-selector select {
      padding: 4px 8px;
      background: #0b0f14;
      border: 1px solid var(--tui-border);
      border-radius: 4px;
      color: var(--tui-text);
      font-size: 12px;
      cursor: pointer;
    }

    .tool-selector select:focus {
      outline: none;
      border-color: var(--tui-accent);
    }

    .special-keys-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .special-key-btn {
      padding: 6px 10px;
      background: #1b212b;
      border: 1px solid var(--tui-border);
      border-radius: 4px;
      color: var(--tui-text);
      font-size: 12px;
      font-family: var(--tui-mono);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .special-key-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .special-key-btn:hover {
      background: #262f3a;
      border-color: var(--tui-accent);
    }

    .special-key-btn:active {
      transform: scale(0.95);
    }

    .special-key-btn.danger {
      border-color: #da3633;
    }

    .special-key-btn.danger:hover {
      background: rgba(218, 54, 51, 0.2);
      border-color: #f85149;
    }

    .special-key-btn .key-label {
      font-weight: 600;
    }

    .special-key-btn .key-desc {
      color: #8b949e;
      font-size: 11px;
    }

    .key-sent-feedback {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #238636;
      color: #fff;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s;
      z-index: 1000;
    }

    .key-sent-feedback.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Activity indicator styles */
    .activity-indicator {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .activity-indicator.active {
      background: #238636;
      color: #fff;
    }

    .activity-indicator.idle {
      background: #9e6a03;
      color: #fff;
    }

    .activity-indicator.waiting {
      background: #1f6feb;
      color: #fff;
    }

    .activity-indicator.stale {
      background: #6e7681;
      color: #fff;
    }

    .activity-indicator.unknown {
      background: #30363d;
      color: #8b949e;
    }

    .preview-empty {
      display: none;
      flex: 1;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #8b949e;
      padding: 40px 20px;
      border: 1px dashed #30363d;
      border-radius: 6px;
      background: rgba(13, 17, 23, 0.6);
    }

    .preview-empty h3 {
      font-size: 18px;
      color: #c9d1d9;
      margin-bottom: 8px;
    }

    @media (max-width: 1100px) {
      .dashboard-layout {
        grid-template-columns: 1fr;
      }

      .sessions-grid {
        max-height: none;
      }

      .sessions-pane {
        border-right: none;
        border-bottom: 1px solid var(--tui-border);
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      h1 {
        font-size: 24px;
      }

      .stat-card {
        padding: 15px;
        min-width: 100%;
      }

      .dashboard-layout {
        border-radius: 10px;
      }

      .sessions-pane,
      .preview-pane {
        padding: 14px 16px;
      }

      .orchestrator-panel {
        padding: 15px;
      }

      .orchestrator-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .orchestrator-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .orchestrator-input-group {
        flex-direction: column;
      }

      .output-header {
        flex-direction: column;
        gap: 12px;
      }

      .output-actions {
        width: 100%;
        justify-content: flex-start;
      }

      .output-actions button {
        flex: 1;
        text-align: center;
        justify-content: center;
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
      }

      .output-panel {
        position: relative;
        padding: 12px;
      }

      .special-keys-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .session-meta .divider,
      .output-meta .meta-divider {
        display: none;
      }

      .send-message {
        flex-direction: column;
      }

      .send-message button {
        width: 100%;
      }

      .tool-selector {
        width: 100%;
      }

      .tool-selector select {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ Coders Dashboard</h1>
    <p class="subtitle">Monitor and interact with your AI coding sessions</p>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="total-sessions">0</div>
        <div class="stat-label">Total Sessions</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="active-sessions">0</div>
        <div class="stat-label">Active Sessions</div>
      </div>
    </div>

    <!-- Orchestrator Panel -->
    <div class="orchestrator-panel hidden" id="orchestrator-panel">
      <div class="orchestrator-header">
        <div class="orchestrator-title">
          <h2>üéØ Orchestrator</h2>
          <div class="status" id="orchestrator-status">unknown</div>
        </div>
      </div>

      <div class="orchestrator-stats" id="orchestrator-stats">
        <div class="orchestrator-stat">
          <div class="orchestrator-stat-label">Last Seen</div>
          <div class="orchestrator-stat-value" id="orchestrator-last-seen">Never</div>
        </div>
        <div class="orchestrator-stat">
          <div class="orchestrator-stat-label">Last Response</div>
          <div class="orchestrator-stat-value" id="orchestrator-last-response">Never</div>
        </div>
        <div class="orchestrator-stat">
          <div class="orchestrator-stat-label">Activity</div>
          <div class="orchestrator-stat-value" id="orchestrator-activity">unknown</div>
        </div>
        <div class="orchestrator-stat">
          <div class="orchestrator-stat-label">Windows</div>
          <div class="orchestrator-stat-value" id="orchestrator-windows">0</div>
        </div>
        <div class="orchestrator-stat">
          <div class="orchestrator-stat-label">Working Directory</div>
          <div class="orchestrator-stat-value" id="orchestrator-cwd" title="">üìÅ unknown</div>
        </div>
      </div>

      <div class="orchestrator-controls">
        <div class="orchestrator-input-group">
          <input
            type="text"
            id="orchestrator-input"
            placeholder="Send command to orchestrator (e.g., 'coders spawn claude --task \"Fix the bug\"')"
          />
          <button onclick="sendToOrchestrator()">Send</button>
        </div>
        <button onclick="viewOrchestratorOutput()">View Output</button>
      </div>
    </div>

    <div class="dashboard-layout">
      <div class="sessions-pane">
        <div class="section-title">Coder Sessions</div>
        <div class="sessions-grid" id="sessions-grid">
          <div class="empty-state">
            <h2>No active sessions</h2>
            <p>Spawn a coder session to get started!</p>
          </div>
        </div>
      </div>

      <div class="preview-pane">
        <div class="section-title">Session Preview</div>
        <div class="output-panel empty" id="output-panel">
          <div class="output-header">
            <div>
              <div class="output-title" id="output-session-name">Session Preview</div>
              <div class="output-meta" id="output-meta">
                <span class="status unknown" id="output-status">unknown</span>
                <span class="meta-divider">‚Ä¢</span>
                <span id="output-last-seen">Last seen: ‚Äî</span>
                <span class="meta-divider">‚Ä¢</span>
                <span id="output-last-output">Last output: ‚Äî</span>
                <span class="meta-divider">‚Ä¢</span>
                <span id="output-windows">Windows: ‚Äî</span>
                <span class="meta-divider">‚Ä¢</span>
                <span id="output-cwd">üìÅ ‚Äî</span>
              </div>
            </div>
            <div class="output-actions">
              <button class="ghost" id="output-refresh" onclick="refreshOutput()" disabled>Refresh</button>
              <button id="output-attach" onclick="attachCurrentSession()" disabled>Attach (tmux)</button>
              <button id="output-kill" onclick="killCurrentSession()" disabled>Kill</button>
              <button class="close-btn" onclick="closeOutput()" title="Clear selection">√ó</button>
            </div>
          </div>
          <div class="output-promise" id="output-promise">
            <div class="output-promise-header">
              <span class="promise-badge" id="output-promise-status">Completed</span>
              <span class="output-promise-time" id="output-promise-time">Completed ‚Äî</span>
            </div>
            <div class="output-promise-summary" id="output-promise-summary"></div>
            <div class="output-promise-blockers" id="output-promise-blockers"></div>
          </div>
          <div class="preview-empty" id="preview-empty">
            <div>
              <h3>Select a session</h3>
              <p>Choose a session on the left to view output and controls.</p>
            </div>
          </div>
          <div class="output-content" id="output-content"></div>
          <div class="send-message">
            <textarea class="message-textarea" id="message-input" placeholder="Type a message to send to this session..." rows="1" disabled></textarea>
            <button id="send-message-btn" onclick="sendMessage()" disabled>Send</button>
          </div>
          <div class="send-message-hint">Press Cmd+Enter (Mac) or Ctrl+Enter (Windows/Linux) to send</div>
          <div class="special-keys-section">
            <div class="special-keys-header">
              <span class="special-keys-title">Special Keys</span>
              <div class="tool-selector">
                <select id="tool-filter" onchange="updateSpecialKeys()">
                  <option value="common">Common</option>
                  <option value="claude">Claude Code</option>
                  <option value="gemini">Gemini CLI</option>
                  <option value="codex">Codex CLI</option>
                  <option value="opencode">OpenCode</option>
                </select>
              </div>
            </div>
            <div class="special-keys-grid" id="special-keys-grid">
              <!-- Keys populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="key-sent-feedback" id="key-feedback">Key sent!</div>

  <script>
    let currentSession = null;
    let currentSessionsData = []; // Store sessions data for displayName lookup
    let updateInterval = null;
    const sessionSignatures = new Map();

    // Special keys configuration by tool
    const SPECIAL_KEYS = {
      common: [
        { key: 'C-c', label: 'Ctrl+C', desc: 'Cancel/Interrupt', danger: true },
        { key: 'C-d', label: 'Ctrl+D', desc: 'Exit', danger: true },
        { key: 'Escape', label: 'Esc', desc: 'Cancel' },
        { key: 'Escape Escape', label: 'Esc Esc', desc: 'Rewind', delay: 100 },
        { key: 'C-l', label: 'Ctrl+L', desc: 'Clear' },
        { key: 'Enter', label: 'Enter', desc: 'Submit' },
        { key: 'Tab', label: 'Tab', desc: 'Complete' },
        { key: 'BTab', label: 'Shift+Tab', desc: 'Toggle' },
        { key: 'Up', label: 'Up', desc: 'History' },
        { key: 'Down', label: 'Down', desc: 'History' },
      ],
      claude: [
        { key: 'C-c', label: 'Ctrl+C', desc: 'Cancel', danger: true },
        { key: 'C-d', label: 'Ctrl+D', desc: 'Exit', danger: true },
        { key: 'C-o', label: 'Ctrl+O', desc: 'Verbose' },
        { key: 'C-b', label: 'Ctrl+B', desc: 'Background' },
        { key: 'Escape Escape', label: 'Esc Esc', desc: 'Rewind', delay: 100 },
        { key: 'C-l', label: 'Ctrl+L', desc: 'Clear' },
        { key: 'C-g', label: 'Ctrl+G', desc: 'Editor' },
        { key: 'C-r', label: 'Ctrl+R', desc: 'History' },
        { key: 'BTab', label: 'Shift+Tab', desc: 'Permissions' },
        { key: 'M-m', label: 'Alt+M', desc: 'Permissions' },
        { key: 'M-p', label: 'Alt+P', desc: 'Model' },
        { key: 'M-t', label: 'Alt+T', desc: 'Thinking' },
        { key: 'C-y', label: 'Ctrl+Y', desc: 'Paste' },
      ],
      gemini: [
        { key: 'C-c', label: 'Ctrl+C', desc: 'Cancel/Quit', danger: true },
        { key: 'C-d', label: 'Ctrl+D', desc: 'Exit', danger: true },
        { key: 'Escape', label: 'Esc', desc: 'Dismiss' },
        { key: 'Escape Escape', label: 'Esc Esc', desc: 'Rewind', delay: 100 },
        { key: 'C-y', label: 'Ctrl+Y', desc: 'YOLO Mode' },
        { key: 'BTab', label: 'Shift+Tab', desc: 'Auto Edit' },
        { key: 'C-l', label: 'Ctrl+L', desc: 'Clear' },
        { key: 'C-t', label: 'Ctrl+T', desc: 'TODO List' },
        { key: 'C-s', label: 'Ctrl+S', desc: 'Copy Mode' },
        { key: 'C-g', label: 'Ctrl+G', desc: 'IDE Context' },
        { key: 'C-x', label: 'Ctrl+X', desc: 'Editor' },
        { key: 'C-j', label: 'Ctrl+J', desc: 'Newline' },
        { key: 'F12', label: 'F12', desc: 'Errors' },
      ],
      codex: [
        { key: 'C-c', label: 'Ctrl+C', desc: 'Close', danger: true },
        { key: 'C-g', label: 'Ctrl+G', desc: 'Editor' },
        { key: 'C-o', label: 'Ctrl+O', desc: 'Cloud Env' },
        { key: 'Escape Escape', label: 'Esc Esc', desc: 'Edit Prev', delay: 100 },
        { key: 'C-k', label: 'Ctrl+K', desc: 'Search' },
        { key: 'Enter', label: 'Enter', desc: 'Submit' },
        { key: 'Tab', label: 'Tab', desc: 'Insert Path' },
      ],
      opencode: [
        { key: 'C-c', label: 'Ctrl+C', desc: 'Exit/Clear', danger: true },
        { key: 'C-d', label: 'Ctrl+D', desc: 'Exit', danger: true },
        { key: 'Escape', label: 'Esc', desc: 'Interrupt' },
        { key: 'C-p', label: 'Ctrl+P', desc: 'Palette' },
        { key: 'C-z', label: 'Ctrl+Z', desc: 'Suspend' },
        { key: 'Tab', label: 'Tab', desc: 'Next Agent' },
        { key: 'BTab', label: 'Shift+Tab', desc: 'Prev Agent' },
        { key: 'F2', label: 'F2', desc: 'Cycle Models' },
        { key: 'S-F2', label: 'Shift+F2', desc: 'Models Rev' },
        { key: 'C-x', label: 'Ctrl+X', desc: 'Leader' },
      ],
    };

    function updateSpecialKeys() {
      const tool = document.getElementById('tool-filter').value;
      const grid = document.getElementById('special-keys-grid');
      const keys = SPECIAL_KEYS[tool] || SPECIAL_KEYS.common;

      grid.innerHTML = keys.map(k => `
        <button class="special-key-btn ${k.danger ? 'danger' : ''}"
                onclick="sendSpecialKey('${k.key}', ${k.delay || 0})"
                title="${k.desc}">
          <span class="key-label">${k.label}</span>
          <span class="key-desc">${k.desc}</span>
        </button>
      `).join('');

      const disabled = !currentSession;
      grid.querySelectorAll('button').forEach(btn => {
        btn.disabled = disabled;
      });
    }

    function getSessionData(sessionId) {
      return currentSessionsData.find(s => s.sessionId === sessionId);
    }

    function buildFallbackSession(sessionId) {
      return {
        sessionId,
        displayName: sessionId === 'coder-orchestrator' ? 'Orchestrator' : null,
        status: 'unknown',
        windows: 0,
        lastSeen: null,
        lastResponseAt: null,
        cwd: ''
      };
    }

    function setOutputControlsEnabled(enabled) {
      document.getElementById('message-input').disabled = !enabled;
      document.getElementById('send-message-btn').disabled = !enabled;
      document.getElementById('output-refresh').disabled = !enabled;
      document.getElementById('output-attach').disabled = !enabled;
      document.getElementById('output-kill').disabled = !enabled;
      updateSpecialKeys();
    }

    function setPreviewSession(sessionData, options = {}) {
      const { preserveInput = false } = options;
      const panel = document.getElementById('output-panel');
      panel.classList.remove('empty');

      const title = sessionData.displayName
        ? `${sessionData.displayName} (${sessionData.sessionId})`
        : sessionData.sessionId;
      document.getElementById('output-session-name').textContent = title || 'Session Preview';

      const status = sessionData.status || 'unknown';
      const statusEl = document.getElementById('output-status');
      statusEl.textContent = status;
      statusEl.className = `status ${status}`;

      const timeSince = sessionData.lastSeen
        ? formatTimeSince(Date.now() - sessionData.lastSeen)
        : 'Never';
      const responseSince = sessionData.lastResponseAt
        ? formatTimeSince(Date.now() - sessionData.lastResponseAt)
        : 'Never';

      document.getElementById('output-last-seen').textContent = `Last seen: ${timeSince}`;
      document.getElementById('output-last-output').textContent = `Last output: ${responseSince}`;
      document.getElementById('output-windows').textContent = `Windows: ${sessionData.windows ?? 0}`;

      const cwdEl = document.getElementById('output-cwd');
      cwdEl.textContent = sessionData.cwd ? `üìÅ ${truncatePath(sessionData.cwd)}` : 'üìÅ ‚Äî';
      cwdEl.title = sessionData.cwd || '';

      updatePromisePanel(sessionData.promise);

      if (!preserveInput) {
        document.getElementById('message-input').value = '';
      }

      // Auto-detect Gemini session to hide text input and select tool
      const isGemini = sessionData.sessionId.toLowerCase().includes('gemini');
      const messageBlock = document.querySelector('.send-message');
      const hintBlock = document.querySelector('.send-message-hint');
      const toolSelect = document.getElementById('tool-filter');

      if (isGemini) {
        messageBlock.style.display = 'none';
        hintBlock.style.display = 'none';
        if (toolSelect.value !== 'gemini') {
          toolSelect.value = 'gemini';
          updateSpecialKeys();
        }
      } else {
        messageBlock.style.display = 'flex';
        hintBlock.style.display = 'block';
        // Reset to common if it was stuck on Gemini (optional, but good for UX)
        // Only reset if we are switching FROM a Gemini session TO a non-Gemini one
        // and the user hasn't explicitly chosen something else? 
        // For simplicity, we won't force-reset it to allow manual overrides, 
        // unless we want to enforce "common" as default.
        // Let's just leave the tool selector as is for non-Gemini sessions.
      }

      setOutputControlsEnabled(true);
    }

    function updatePromisePanel(promise) {
      const panel = document.getElementById('output-promise');
      if (!promise) {
        panel.classList.remove('visible', 'blocked', 'needs-review');
        document.getElementById('output-promise-summary').textContent = '';
        document.getElementById('output-promise-time').textContent = 'Completed ‚Äî';
        document.getElementById('output-promise-status').textContent = 'Completed';
        document.getElementById('output-promise-blockers').textContent = '';
        return;
      }

      const status = promise.status || 'completed';
      panel.classList.add('visible');
      panel.classList.toggle('blocked', status === 'blocked');
      panel.classList.toggle('needs-review', status === 'needs-review');

      const statusLabel = formatPromiseStatus(status);
      const timestampLabel = formatTimestamp(promise.timestamp);

      const statusEl = document.getElementById('output-promise-status');
      statusEl.textContent = statusLabel;
      statusEl.className = `promise-badge ${status}`;

      document.getElementById('output-promise-time').textContent = `Completed ${timestampLabel}`;
      document.getElementById('output-promise-summary').textContent = promise.summary || '';

      const blockersEl = document.getElementById('output-promise-blockers');
      if (status === 'blocked' && promise.blockers && promise.blockers.length > 0) {
        blockersEl.textContent = `Blockers: ${promise.blockers.join(', ')}`;
      } else {
        blockersEl.textContent = '';
      }
    }

    function clearPreview() {
      currentSession = null;
      const panel = document.getElementById('output-panel');
      panel.classList.add('empty');
      document.getElementById('output-session-name').textContent = 'Session Preview';
      const statusEl = document.getElementById('output-status');
      statusEl.textContent = 'unknown';
      statusEl.className = 'status unknown';
      document.getElementById('output-last-seen').textContent = 'Last seen: ‚Äî';
      document.getElementById('output-last-output').textContent = 'Last output: ‚Äî';
      document.getElementById('output-windows').textContent = 'Windows: ‚Äî';
      const cwdEl = document.getElementById('output-cwd');
      cwdEl.textContent = 'üìÅ ‚Äî';
      cwdEl.title = '';
      document.getElementById('output-content').innerHTML = '';
      document.getElementById('message-input').value = '';
      updatePromisePanel(null);
      setOutputControlsEnabled(false);
    }

    function selectSession(sessionId) {
      const sessionData = getSessionData(sessionId) || buildFallbackSession(sessionId);
      currentSession = sessionId;
      setPreviewSession(sessionData);
      viewOutput(sessionId);
      renderSessions(currentSessionsData);
    }

    function refreshOutput() {
      if (currentSession) {
        viewOutput(currentSession, true);
      }
    }

    function attachCurrentSession() {
      if (!currentSession) return;
      attachSession(currentSession);
    }

    function killCurrentSession() {
      if (!currentSession) return;
      killSession(currentSession);
    }

    async function sendSpecialKey(key, delay = 0) {
      if (!currentSession) return;

      const response = await fetch('/api/send-key', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session: currentSession, key, delay })
      });

      const result = await response.json();

      if (result.success) {
        showKeyFeedback(`Sent: ${key}`);
        setTimeout(() => viewOutput(currentSession, true), 500);
      } else {
        alert('Failed to send key: ' + result.error);
      }
    }

    function showKeyFeedback(message) {
      const feedback = document.getElementById('key-feedback');
      feedback.textContent = message;
      feedback.classList.add('visible');
      setTimeout(() => feedback.classList.remove('visible'), 1500);
    }

    async function fetchSessions() {
      try {
        const response = await fetch('/api/sessions');
        const sessions = await response.json();
        renderSessions(sessions);
        updateStats(sessions);
      } catch (e) {
        console.error('Failed to fetch sessions:', e);
      }
    }

    function updateStats(sessions) {
      document.getElementById('total-sessions').textContent = sessions.length;
      document.getElementById('active-sessions').textContent =
        sessions.filter(s => s.status === 'active').length;
    }

    function renderSessions(sessions) {
      // Store sessions data globally for displayName lookup
      currentSessionsData = sessions;

      // Separate orchestrator from regular sessions
      const orchestrator = sessions.find(s => s.isOrchestrator);
      const regularSessions = sessions.filter(s => !s.isOrchestrator);

      // Update orchestrator panel
      const orchestratorPanel = document.getElementById('orchestrator-panel');
      if (orchestrator) {
        orchestratorPanel.classList.remove('hidden');

        const timeSince = orchestrator.lastSeen
          ? formatTimeSince(Date.now() - orchestrator.lastSeen)
          : 'Never';
        const responseAgeMs = orchestrator.lastResponseAt
          ? Date.now() - orchestrator.lastResponseAt
          : null;
        const responseSince = responseAgeMs !== null
          ? formatTimeSince(responseAgeMs)
          : 'Never';

        document.getElementById('orchestrator-status').textContent = orchestrator.status;
        document.getElementById('orchestrator-status').className = `status ${orchestrator.status}`;
        document.getElementById('orchestrator-last-seen').textContent = timeSince;
        document.getElementById('orchestrator-last-response').textContent = responseSince;
        const activityEl = document.getElementById('orchestrator-activity');
        activityEl.textContent = orchestrator.lastActivity;
        activityEl.className = `orchestrator-stat-value activity-indicator ${orchestrator.lastActivity}`;
        document.getElementById('orchestrator-windows').textContent = orchestrator.windows;

        const cwdEl = document.getElementById('orchestrator-cwd');
        cwdEl.textContent = 'üìÅ ' + truncatePath(orchestrator.cwd);
        cwdEl.title = orchestrator.cwd || '';
      } else {
        orchestratorPanel.classList.add('hidden');
      }

      // Render regular sessions grid
      const grid = document.getElementById('sessions-grid');
      if (regularSessions.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <h2>No active sessions</h2>
            <p>Spawn a coder session to get started!</p>
          </div>
        `;
      }

      function renderSessionCard(session) {
        const timeSince = session.lastSeen
          ? formatTimeSince(Date.now() - session.lastSeen)
          : 'Never';
        const responseAgeMs = session.lastResponseAt
          ? Date.now() - session.lastResponseAt
          : null;
        const responseSince = responseAgeMs !== null
          ? formatTimeSince(responseAgeMs)
          : 'Never';
        const isTyping = responseAgeMs !== null && responseAgeMs <= 5000;
        const isStale = responseAgeMs !== null && responseAgeMs > 5 * 60 * 1000;
        const typingIndicator = isTyping
          ? `<span class="typing-indicator" title="Recent response">
              <span class="typing-dot"></span>
              <span class="typing-dot"></span>
              <span class="typing-dot"></span>
            </span>`
          : '';

        const signature = JSON.stringify({
          status: session.status,
          lastSeen: session.lastSeen,
          lastResponseAt: session.lastResponseAt,
          windows: session.windows,
          lastActivity: session.lastActivity,
          paneId: session.paneId,
          promise: session.promise
            ? {
                status: session.promise.status,
                timestamp: session.promise.timestamp,
                summary: session.promise.summary,
                blockers: session.promise.blockers
              }
            : null
        });
        const previousSignature = sessionSignatures.get(session.sessionId);
        const isUpdated = previousSignature && previousSignature !== signature;
        sessionSignatures.set(session.sessionId, signature);

        const heartbeatClass = session.hasHeartbeat ? 'has-heartbeat' : 'no-heartbeat';
        const heartbeatTitle = session.hasHeartbeat ? 'Heartbeat active' : 'No heartbeat';
        const isSelected = session.sessionId === currentSession;
        const promise = session.promise;
        const hasPromise = session.hasPromise && promise;
        const promiseStatus = hasPromise ? (promise.status || 'completed') : null;
        const promiseBadge = hasPromise
          ? `<span class="promise-badge ${promiseStatus}">${formatPromiseStatus(promiseStatus)}</span>`
          : '';
        const promiseTime = hasPromise
          ? `Completed ${formatTimestamp(promise.timestamp)}`
          : '';
        const promiseSummary = hasPromise
          ? `<div class="promise-summary">
               <div class="promise-time">${escapeHtml(promiseTime)}</div>
               <div class="promise-text">${escapeHtml(truncateText(promise.summary || '', 160))}</div>
               ${promiseStatus === 'blocked' && promise.blockers && promise.blockers.length > 0
                 ? `<div class="promise-blockers">Blockers: ${escapeHtml(promise.blockers.join(', '))}</div>`
                 : ''}
             </div>`
          : '';
        const promiseClass = hasPromise
          ? `completed ${promiseStatus === 'completed' ? '' : promiseStatus}`
          : '';

        // Use displayName if available, otherwise fall back to sessionId
        const nameDisplay = session.displayName
          ? `<div class="session-name-container">
               <div class="session-display-name">${session.displayName}</div>
               <div class="session-id">${session.sessionId}</div>
             </div>`
          : `<div class="session-name">${session.sessionId}</div>`;

        const taskLine = session.task
          ? `<div class="session-task" title="${escapeHtml(session.task)}">üìù ${escapeHtml(truncateText(session.task, 140))}</div>`
          : '';

        return `
          <div class="session-card ${promiseClass} ${isStale ? 'stale' : ''} ${isUpdated ? 'pulse' : ''} ${isSelected ? 'selected' : ''}" id="session-${session.sessionId.replace(/[^a-zA-Z0-9-]/g, '-')}" onclick="selectSession('${session.sessionId}')">
            <div class="session-header">
              ${nameDisplay}
              <div class="session-statuses">
                <div class="status ${session.status}">${session.status}</div>
                ${promiseBadge}
              </div>
            </div>
            ${taskLine}
            <div class="session-meta">
              <span class="heartbeat-indicator ${heartbeatClass}" title="${heartbeatTitle}"></span>
              <span>Seen ${timeSince}</span>
              <span class="divider">‚Ä¢</span>
              <span>Output ${responseSince} ${typingIndicator}</span>
              <span class="divider">‚Ä¢</span>
              <span>Windows ${session.windows}</span>
            </div>
            ${session.cwd ? `<div class="session-meta"><span title="${session.cwd}">üìÅ ${truncatePath(session.cwd)}</span></div>` : ''}
            ${promiseSummary}
          </div>
        `;
      }

      if (regularSessions.length > 0) {
        grid.innerHTML = regularSessions.map(session => renderSessionCard(session)).join('');
      }

      const activeIds = new Set(regularSessions.map(s => s.sessionId));
      for (const sessionId of sessionSignatures.keys()) {
        if (!activeIds.has(sessionId)) {
          sessionSignatures.delete(sessionId);
        }
      }

      if (currentSession) {
        const currentData = getSessionData(currentSession);
        if (currentData) {
          setPreviewSession(currentData, { preserveInput: true });
        } else {
          clearPreview();
        }
      }
    }

    function formatTimeSince(ms) {
      const seconds = Math.floor(ms / 1000);
      if (seconds < 60) return `${seconds}s ago`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      return `${hours}h ago`;
    }

    function formatTimestamp(ts) {
      if (!ts) return '‚Äî';
      const date = new Date(ts);
      return date.toLocaleString(undefined, {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
    }

    function formatPromiseStatus(status) {
      if (!status) return 'Completed';
      return status.replace(/-/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
    }

    function truncatePath(path) {
      if (!path) return 'unknown';
      const maxLen = 45;
      if (path.length <= maxLen) return path;
      // Replace home directory with ~
      const home = path.match(/^\/Users\/[^/]+/) || path.match(/^\/home\/[^/]+/);
      const normalized = home ? path.replace(home[0], '~') : path;
      if (normalized.length <= maxLen) return normalized;
      // Show .../ + last 2 path components
      const parts = normalized.split('/');
      if (parts.length > 2) {
        return '.../' + parts.slice(-2).join('/');
      }
      return normalized.slice(-maxLen);
    }

    function truncateText(text, maxLen = 140) {
      if (!text) return '';
      return text.length > maxLen ? text.slice(0, maxLen - 1) + '‚Ä¶' : text;
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    const ansiUp = new AnsiUp();

    async function viewOutput(sessionId, isRefresh = false) {
      if (!sessionId) return;

      const response = await fetch(`/api/output?session=${sessionId}&lines=50`);
      const data = await response.json();
      
      const content = document.getElementById('output-content');
      const isAtBottom = content.scrollHeight - content.scrollTop === content.clientHeight;

      const html = ansiUp.ansi_to_html(data.output);
      content.innerHTML = html;

      // Auto-scroll to bottom only if we were already there or it's a fresh open
      if (!isRefresh || isAtBottom) {
        content.scrollTop = content.scrollHeight;
      }
    }

    function closeOutput() {
      clearPreview();
      renderSessions(currentSessionsData);
    }

    async function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();

      if (!message || !currentSession) return;

      const response = await fetch('/api/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session: currentSession, message })
      });

      const result = await response.json();

      if (result.success) {
        input.value = '';
        // Refresh output after a delay
        setTimeout(() => viewOutput(currentSession), 2000);
      } else {
        alert('Failed to send message: ' + result.error);
      }
    }

    function attachSession(sessionId) {
      alert(`To attach to this session, run:\n\ntmux attach -t ${sessionId}`);
    }

    async function sendToOrchestrator() {
      const input = document.getElementById('orchestrator-input');
      const message = input.value.trim();

      if (!message) return;

      const response = await fetch('/api/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session: 'coder-orchestrator', message })
      });

      const result = await response.json();

      if (result.success) {
        input.value = '';
        // Show success feedback
        const originalPlaceholder = input.placeholder;
        input.placeholder = '‚úì Sent successfully!';
        setTimeout(() => {
          input.placeholder = originalPlaceholder;
        }, 2000);
      } else {
        alert('Failed to send message: ' + result.error);
      }
    }

    function viewOrchestratorOutput() {
      selectSession('coder-orchestrator');
    }

    async function killSession(sessionId) {
      const confirmed = confirm(`Kill session "${sessionId}"? This cannot be undone.`);
      if (!confirmed) return;

      try {
        const response = await fetch('/api/kill', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session: sessionId })
        });

        const result = await response.json();
        if (!result.success) {
          alert(`Failed to kill session: ${result.error}`);
          return;
        }

        if (currentSession === sessionId) {
          closeOutput();
        }
        fetchSessions();
      } catch (e) {
        alert(`Failed to kill session: ${e.message}`);
      }
    }

    // Handle keyboard shortcuts in message inputs
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('message-input')?.addEventListener('keydown', (e) => {
        // Cmd+Enter (Mac) or Ctrl+Enter (Windows/Linux) to send
        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
          e.preventDefault();
          sendMessage();
        }
      });

      document.getElementById('orchestrator-input')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendToOrchestrator();
      });

      // Initialize preview state
      clearPreview();

      // Start SSE
      setupSSE();
      // Also fetch once immediately
      fetchSessions();
    });

    // Server-Sent Events
    function setupSSE() {
      const evtSource = new EventSource("/api/events");
      
      evtSource.onmessage = (event) => {
        try {
          const payload = JSON.parse(event.data);
          
          if (payload.type === 'sessions') {
            renderSessions(payload.data);
            updateStats(payload.data);
          } else if (payload.type === 'reload') {
            console.log('Reload signal received');
            window.location.reload();
          }
        } catch (e) {
          console.error('SSE Parse Error:', e);
        }
      };

      evtSource.onerror = (err) => {
        console.error("EventSource failed:", err);
        // EventSource auto-reconnects, but if it fails permanently we might want to warn
      };
    }

    // Auto-refresh output if active
    updateInterval = setInterval(() => {
      if (currentSession) {
        viewOutput(currentSession, true);
      }
    }, 3000);
  </script>
</body>
</html>
